<?php
/**
 * Termly Cross-Domain Consent Sync v3.0
 * 
 * FIXED: Now properly applies consent from other domains instead of overwriting
 * 
 * Syncs Termly consent preferences between www.mywebsite.com 
 * and hs.mywebsite.com via shared cookie
 * 
 * Plugin: Code Snippets
 * Location: Run snippet everywhere (Frontend only)
 */

add_action('wp_footer', function () {
    ?>
    <script id="termly-consent-sync">
    /**
     * Termly Cross-Domain Consent Sync v3.0
     * Fixed to properly apply consent from other domains
     */
    (function(){"use strict";const CONFIG={rootDomain:"mywebsite.com",cookieName:"termly_consent_sync",cookieExpireDays:365,debug:false};const Utils={log:function(...args){if(CONFIG.debug)console.log("[Termly Sync]",...args)},setCookie:function(name,value,days){const date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));const expires="expires="+date.toUTCString();const domain="."+CONFIG.rootDomain;document.cookie=name+"="+encodeURIComponent(value)+";"+expires+";path=/;domain="+domain+";SameSite=Lax;Secure";Utils.log("Cookie set:",name)},getCookie:function(name){const nameEQ=name+"=";const ca=document.cookie.split(";");for(let i=0;i<ca.length;i++){let c=ca[i].trim();if(c.indexOf(nameEQ)===0)return decodeURIComponent(c.substring(nameEQ.length))}return null},deleteCookie:function(name){const domain="."+CONFIG.rootDomain;document.cookie=name+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain="+domain},parseJSON:function(str){try{return JSON.parse(str)}catch(e){return null}},getTimestamp:function(){return new Date().toISOString()}};const TermlyConsentSync={appliedFromOtherDomain:false,init:function(){Utils.log("Initializing v3.0...");const applied=this.applySharedConsent();if(applied){Utils.log("Applied consent from other domain - will not overwrite");this.appliedFromOtherDomain=true}this.setupTermlyListeners();this.watchLocalStorage();this.watchConsentModal();Utils.log("Initialized")},getTermlyConsent:function(){const apiCache=localStorage.getItem("TERMLY_API_CACHE");if(apiCache){const parsed=Utils.parseJSON(apiCache);if(parsed&&parsed.TERMLY_COOKIE_CONSENT&&parsed.TERMLY_COOKIE_CONSENT.value){return{key:"TERMLY_API_CACHE",value:apiCache,consent:parsed.TERMLY_COOKIE_CONSENT.value,format:"api_cache"}}}const gtmConsent=localStorage.getItem("termly_gtm_template_default_consents");if(gtmConsent){return{key:"termly_gtm_template_default_consents",value:gtmConsent,consent:Utils.parseJSON(gtmConsent),format:"gtm"}}return null},convertConsentFormat:function(consent,fromFormat,toFormat){if(fromFormat===toFormat)return consent;if(fromFormat==="api_cache"&&toFormat==="gtm"){return{ad_personalization:consent.advertising?"granted":"denied",ad_storage:consent.advertising?"granted":"denied",ad_user_data:consent.advertising?"granted":"denied",analytics_storage:consent.analytics?"granted":"denied",functionality_storage:consent.performance?"granted":"denied",personalization_storage:consent.performance?"granted":"denied",security_storage:"granted",social_storage:consent.social_networking?"granted":"denied",unclassified_storage:consent.unclassified?"granted":"denied"}}if(fromFormat==="gtm"&&toFormat==="api_cache"){return{essential:true,performance:consent.functionality_storage==="granted",analytics:consent.analytics_storage==="granted",advertising:consent.ad_storage==="granted",social_networking:consent.social_storage==="granted",unclassified:consent.unclassified_storage==="granted"}}return consent},buildConsentState:function(){const termlyConsent=this.getTermlyConsent();return{version:"3.0",timestamp:Utils.getTimestamp(),source:window.location.hostname,consent:termlyConsent?termlyConsent.consent:null,format:termlyConsent?termlyConsent.format:null,rawKey:termlyConsent?termlyConsent.key:null,rawValue:termlyConsent?termlyConsent.value:null}},saveConsentState:function(){if(this.appliedFromOtherDomain){Utils.log("Skipping save - consent was applied from other domain");return}const consentState=this.buildConsentState();if(consentState.consent){Utils.log("Saving consent state");Utils.setCookie(CONFIG.cookieName,JSON.stringify(consentState),CONFIG.cookieExpireDays)}},applySharedConsent:function(){const sharedConsent=Utils.getCookie(CONFIG.cookieName);if(!sharedConsent){Utils.log("No shared consent cookie");return false}const consentState=Utils.parseJSON(sharedConsent);if(!consentState||!consentState.consent){Utils.log("Invalid consent cookie");return false}if(consentState.source===window.location.hostname){Utils.log("Cookie is from current domain, not applying");return false}Utils.log("Found consent from:",consentState.source);const currentConsent=this.getTermlyConsent();const currentFormat=currentConsent?currentConsent.format:"gtm";let consentToApply=consentState.consent;if(consentState.format&&consentState.format!==currentFormat){consentToApply=this.convertConsentFormat(consentState.consent,consentState.format,currentFormat);Utils.log("Converted consent format from",consentState.format,"to",currentFormat)}if(currentFormat==="gtm"){try{localStorage.setItem("termly_gtm_template_default_consents",JSON.stringify(consentToApply));Utils.log("Applied GTM consent:",consentToApply)}catch(e){Utils.log("Failed to apply GTM consent:",e)}}if(consentState.rawKey==="TERMLY_API_CACHE"&&consentState.rawValue){try{localStorage.setItem("TERMLY_API_CACHE",consentState.rawValue);Utils.log("Applied TERMLY_API_CACHE")}catch(e){Utils.log("Failed to apply API cache:",e)}}return true},enableSaving:function(){Utils.log("Enabling saving - user interacted with consent");this.appliedFromOtherDomain=false},setupTermlyListeners:function(){const self=this;const termlyEvents=["termly:consentUpdated","termly:consentSaved","termly_consent_updated"];termlyEvents.forEach(function(eventName){window.addEventListener(eventName,function(){Utils.log("Termly event:",eventName);self.enableSaving();setTimeout(function(){self.saveConsentState()},100)})});this.waitForTermly()},waitForTermly:function(){const self=this;const checkTermly=function(){if(typeof window.Termly!=="undefined"||typeof window.termly!=="undefined"){Utils.log("Termly found");self.hookTermlyAPI()}else{setTimeout(checkTermly,500)}};checkTermly()},hookTermlyAPI:function(){const termly=window.Termly||window.termly;const self=this;if(termly&&typeof termly.on==="function"){termly.on("consent",function(){Utils.log("Termly consent event");self.enableSaving();self.saveConsentState()})}},watchLocalStorage:function(){const self=this;let lastValue=null;setInterval(function(){const current=self.getTermlyConsent();const currentValue=current?JSON.stringify(current.consent):null;if(currentValue!==lastValue&&lastValue!==null){Utils.log("localStorage changed");self.enableSaving();self.saveConsentState()}lastValue=currentValue},1000)},watchConsentModal:function(){const self=this;const observer=new MutationObserver(function(mutations){for(const mutation of mutations){for(const node of mutation.addedNodes){if(node.nodeType===Node.ELEMENT_NODE){const element=node;if((element.id&&element.id.toLowerCase().includes("termly"))||(element.className&&element.className.toLowerCase&&element.className.toLowerCase().includes("termly"))){self.attachButtonListeners(element)}const termlyEls=element.querySelectorAll('[id*="termly"],[class*="termly"]');termlyEls.forEach(function(el){self.attachButtonListeners(el)})}}}});if(document.body){observer.observe(document.body,{childList:true,subtree:true})}},attachButtonListeners:function(container){const self=this;const selectors=['button[class*="accept"]','button[class*="decline"]','button[class*="save"]','button[class*="allow"]','[role="button"]'];selectors.forEach(function(selector){try{const buttons=container.querySelectorAll(selector);buttons.forEach(function(btn){if(!btn.hasAttribute("data-sync-attached")){btn.setAttribute("data-sync-attached","true");btn.addEventListener("click",function(){Utils.log("Consent button clicked");self.enableSaving();setTimeout(function(){self.saveConsentState()},500);setTimeout(function(){self.saveConsentState()},1500)})}})}catch(e){}})},sync:function(){Utils.log("Manual sync");this.enableSaving();this.saveConsentState()},clearSync:function(){Utils.log("Clearing sync");Utils.deleteCookie(CONFIG.cookieName)},getDebugInfo:function(){return{config:CONFIG,currentHostname:window.location.hostname,appliedFromOtherDomain:this.appliedFromOtherDomain,termlyConsent:this.getTermlyConsent(),sharedConsentCookie:Utils.parseJSON(Utils.getCookie(CONFIG.cookieName)),builtConsentState:this.buildConsentState()}}};if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",function(){TermlyConsentSync.init()})}else{TermlyConsentSync.init()}window.TermlyConsentSync=TermlyConsentSync})();
    </script>
    <?php
}, 100);